@using OpenAI.GPT3.ObjectModels.RequestModels
@inject StatusAppClient StatusAppClient
@inject DataState DataState
@inject SswRulesGptDialogService SswRulesGptDialogService
@inject ApiKeyValidationService ApiKeyValidationService
@inject NotifierService NotifierService
@inject SignalRClient SignalR
@inject IJSRuntime Js
@inject ISnackbar Snackbar

<style>
    .mud-markdown-body p:last-child,
    .mud-markdown-body ol:last-child,
    .mud-markdown-body ol:last-child {
        margin-bottom: 0 !important;
    }
    
    .mud-link {
        color: #CC4141 !important;
    }

    .chat-box {
        max-width: 70%;
    }
    
    @@media screen and (max-width: 600px) {
        .chat-box {
            max-width: 85%;
        }
    }
</style>

@* <MudText> *@
@*     Using Client Side Chat Completion Api *@
@*     @DataState.UseClientSideChatCompletionApi *@
@* </MudText> *@

<div style="display: grid; grid-template-rows: 1fr auto; height: 100%; padding: 24px 0;">
    <MudPaper Elevation="0" Style="background: #f9fbfc; border: 1px solid #e6e6e6; overflow-y: auto; height: 100%">
        <MudContainer Class="pa-0" Style="height: 100%">
            @if (DataState.ChatMessages.Count == 0)
            {
                <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Style="height: 60%">
                    <MudText Typo="Typo.h3">
                        <b>RulesGPT</b>
                    </MudText>
                    <MudStack Class="pt-4">
                        <MudButton Variant="Variant.Outlined" EndIcon="@Icons.Material.Filled.ArrowForward" OnClick="@(() => OnExampleClicked("What is a v2 email?"))">
                            What is a v2 email?
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" EndIcon="@Icons.Material.Filled.ArrowForward" OnClick="@(() => OnExampleClicked("How can I get better at presenting?"))">
                            How can I get better at presenting?
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" EndIcon="@Icons.Material.Filled.ArrowForward" OnClick="@(() => OnExampleClicked("Give me some rules to better GPT"))">
                            Give me some rules to better GPT
                        </MudButton>
                    </MudStack>
                </MudStack>
            }
            else
            {
                <MudList Class="py-0 chatContainer" DisableGutters="true">
                @foreach (var message in DataState.ChatMessages.Where(s => s.Role != "system"))
                {
                    var isUser = message.Role == "user";
                    <MudListItem>
                        @if (isUser)
                        {
                            <MudStack Class="mx-4" Row="true">
                                <MudSpacer/>
                                <MudStack Spacing="1" Class="chat-box">
                                    <MudText Typo="Typo.body1" Align="Align.Right"><b>You</b></MudText>
                                    <MudPaper Elevation="1" Class="px-4 py-3" Style="background: #323332; color: white">
                                        <MudText Typo="Typo.body1" Class="" Style="white-space: pre-wrap">@(message.Content)</MudText>
                                    </MudPaper>
                                </MudStack>
                                <MudAvatar>
                                    <MudIcon Icon="@Icons.Material.Filled.Person"></MudIcon>
                                </MudAvatar>
                            </MudStack>
                        }
                        else
                        {
                            <MudStack Class="mx-4" Row="true">
                                <MudAvatar>
                                    <MudImage Src="images/chatgpt-icon.svg"></MudImage>
                                </MudAvatar>
                                <MudStack Spacing="1" Class="chat-box">
                                    <MudText Typo="Typo.body1"><b>RulesGPT</b></MudText>
                                        @if (IsAwaitingResponseStream && string.IsNullOrWhiteSpace(message.Content))
                                        {
                                            <MudPaper Elevation="1" Class="px-4 py-3" Style="background: white; color: black; text-align: center;">
                                                <MudProgressCircular Size="Size.Small" Color="Color.Secondary" Indeterminate="true" Style="vertical-align: bottom;"/>
                                            </MudPaper>
                                        }
                                        else
                                        {
                                            <MudPaper Elevation="1" Class="px-4 py-3" Style="background: white; color: black;">
                                                <MudMarkdown Value="@message.Content"/>
                                            </MudPaper>
                                        }
                                    </MudStack>
                                </MudStack>
                            }
                        </MudListItem>
                    }
                </MudList>
            }
        </MudContainer>
        <MudPopover Open="IsAwaitingResponse" OverflowBehavior="OverflowBehavior.FlipNever" AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.BottomCenter" Paper="false">
                <MudButton Class="mb-3" OnClick="CancelStreamingResponse" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Cancel" Color="Color.Primary">Cancel Request</MudButton>
        	</MudPopover>
    </MudPaper>
    @*<MudPaper Elevation="2" Class="mt-5">*@

    <MudStack Row="true" Class="mt-3">
        <MudTextField Style="height: 100%;" Clearable="true" Disabled="IsAwaitingResponse" Class="mt-0" @bind-Value="NewMessageString" OnKeyDown="MessageTextFieldHandleEnterKey" Immediate="true" Label="Ask a question!" Variant="Variant.Filled"></MudTextField>
        <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="SendMessage">
            <MudIcon Icon="@Icons.Material.Filled.Send"></MudIcon>
        </MudButton>
    </MudStack>
    @*</MudPaper>*@
</div>


@code {
    public string NewMessageString { get; set; } = string.Empty;
    public bool IsAwaitingResponseStream { get; set; } = false;
    private bool IsAwaitingResponse { get; set; } = false;
    

    protected override async Task OnInitializedAsync()
    {
        NotifierService.Notify += OnNotify;
        // Only for use when styling
        //DataState.ChatMessages.Add(new ChatMessage("user", "Hello, I'm a user"));
        //DataState.ChatMessages.Add(new ChatMessage("assistant", "Hello, I'm an assistant"));
    }

    private async Task OnExampleClicked(string message)
    {
        NewMessageString = message;
        await SendMessage();
    }

    public async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(NewMessageString))
        {
            return;
        }
        
        if (SignalR.GetConnectionState() == SignalRClient.StatusHubConnectionState.Disconnected)
        {
            try
            {
                await SignalR.StartAsync(DataState.CancellationTokenSource.Token);
            }
            catch (HttpRequestException e)
            {
                Snackbar.Add("Unable to connect to SSW RulesGPT", Severity.Error);
                return;
            }
        }
        var newChatMessage = new ChatMessage("user", NewMessageString);
        NewMessageString = string.Empty;
        DataState.ChatMessages.Add(newChatMessage);

        var newAssistantMessage = new ChatMessage("assistant", string.Empty);

        DataState.ChatMessages.Add(newAssistantMessage);
        IsAwaitingResponseStream = true;
        IsAwaitingResponse = true;
        StateHasChanged();

        
        await JsScrollMessageListToBottom();
        
        var resultStream = SignalR.RequestNewCompletionMessage(
            DataState.ChatMessages,
            DataState.OpenAiApiKey,
            DataState.CancellationTokenSource.Token );
        
        await JsScrollMessageListToBottom();
        await foreach (var result in resultStream.WithCancellation(DataState.CancellationTokenSource.Token))
        {
            IsAwaitingResponseStream = false;
            newAssistantMessage.Content += result?.Content;
            StateHasChanged();
            await JsScrollMessageListToBottom();
        }
        IsAwaitingResponseStream = false;
        IsAwaitingResponse = false;
        DataState.CancellationTokenSource.Dispose();
        DataState.CancellationTokenSource = new CancellationTokenSource();
    }

    async Task MessageTextFieldHandleEnterKey(KeyboardEventArgs args)
    {
        if (args is { Key: "Enter", ShiftKey: false })
        {
            await SendMessage();
        }
    }

    public async Task OnNotify()
    {
        await InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        NotifierService.Notify -= OnNotify;
    }
    
    private async Task JsScrollMessageListToBottom()
    {
        await Js.InvokeVoidAsync("scrollLatestMessageIntoView");
    }
    
    private async Task CancelStreamingResponse()
    {
        DataState.CancellationTokenSource.Cancel();
        DataState.CancellationTokenSource.Dispose();
        var lastAssistantMessage = DataState.ChatMessages.Last(s => s.Role == "assistant");
        if (string.IsNullOrWhiteSpace(lastAssistantMessage.Content))
        {
            DataState.ChatMessages.Remove(lastAssistantMessage);
        }
        IsAwaitingResponse = false;
        IsAwaitingResponseStream = false;
        DataState.CancellationTokenSource = new CancellationTokenSource();
    }
}